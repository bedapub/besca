.. note::
    :class: sphx-glr-download-link-note

    Click :ref:`here <sphx_glr_download_auto_examples_preprocessing_plot_pca_neighbors_clustering.py>` to download the full example code
.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_preprocessing_plot_pca_neighbors_clustering.py:


cluster generation
==================

This example demonstrates how to perform highly variable gene selection, PCA, nearest neighbor calculation, and clustering.




.. code-block:: python


    import besca as bc
    import scanpy.api as sc

    #import example dataset that has previously been filtered
    adata = bc.datasets.pbmc3k_filtered()
    adata







highly variable gene selection
------------------------------

select highly variable genes (considers correction for gene expression level)



.. code-block:: python


    #define thresholds for highly variable genes
    variable_genes_min_mean = 0.01
    variable_genes_max_mean = 5
    variable_genes_min_disp = 0.4

    #identify genes with variable expression
    filter_result = sc.pp.filter_genes_dispersion(adata.X, min_mean=variable_genes_min_mean, max_mean=variable_genes_max_mean, min_disp=variable_genes_min_disp) 
    sc.pl.filter_genes_dispersion(filter_result)
    nbr_variable_genes = sum(filter_result.gene_subset)
    print('number of variable genes selected ', nbr_variable_genes )

    #perform the actual filtering
    adata = adata[:, filter_result.gene_subset]




.. image:: /auto_examples/preprocessing/images/sphx_glr_plot_pca_neighbors_clustering_001.png
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    number of variable genes selected  1869


set random seed
---------------
To get reproducible results you need to define a random seed for all of the stochastic
processes, such as e.g. PCA, neighbors, etc.



.. code-block:: python


    #set random seed
    random_seed = 0







PCA
---



.. code-block:: python


    #log transform our data (is easier to work with numbers like this)
    sc.pp.log1p(adata)

    # Scale data to unit variance and zero mean, and cut-off at max value 10
    sc.pp.scale(adata, max_value=10) 

    #calculate 50 principle components of the dataset
    sc.tl.pca(adata, random_state=random_seed, svd_solver='arpack')

    #visualize the amount of variance explained by each PC
    sc.pl.pca_variance_ratio(adata)

    #visualize the loadings onto the first 3 PCs
    sc.pl.pca_loadings(adata)




.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /auto_examples/preprocessing/images/sphx_glr_plot_pca_neighbors_clustering_002.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/preprocessing/images/sphx_glr_plot_pca_neighbors_clustering_003.png
            :class: sphx-glr-multi-img




nearest neighbors
-----------------



.. code-block:: python


    sc.pp.neighbors(adata, n_neighbors=15, random_state = random_seed, n_pcs=50)







louvain clustering
------------------



.. code-block:: python


    sc.tl.louvain(adata, random_state=random_seed)







UMAP and t-SNE generation
-------------------------



.. code-block:: python


    #calculate UMAP
    sc.tl.umap(adata, random_state = random_seed)

    #calculate t-SNE
    sc.tl.tsne(adata, random_state = random_seed)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    WARNING: Consider installing the package MulticoreTSNE (https://github.com/DmitryUlyanov/Multicore-TSNE). Even for n_jobs=1 this speeds up the computation considerably and might yield better converged results.


visualize the results
---------------------



.. code-block:: python


    sc.pl.umap(adata, color = ['louvain'])
    sc.pl.tsne(adata, color = ['louvain'])


.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /auto_examples/preprocessing/images/sphx_glr_plot_pca_neighbors_clustering_004.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/preprocessing/images/sphx_glr_plot_pca_neighbors_clustering_005.png
            :class: sphx-glr-multi-img




**Total running time of the script:** ( 0 minutes  38.854 seconds)


.. _sphx_glr_download_auto_examples_preprocessing_plot_pca_neighbors_clustering.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download

     :download:`Download Python source code: plot_pca_neighbors_clustering.py <plot_pca_neighbors_clustering.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: plot_pca_neighbors_clustering.ipynb <plot_pca_neighbors_clustering.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.readthedocs.io>`_
